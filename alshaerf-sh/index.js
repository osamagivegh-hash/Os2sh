const express = require('express');
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const session = require('express-session');
const bodyParser = require('body-parser');
const path = require('path');
const fs = require('fs');
const multer = require('multer');

// Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const News = require('./models/News');
const User = require('./models/User');
const Comment = require('./models/Comment');

const app = express();

// ðŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù‡Ù…Ø© Ù„Ù€ Render
const isProduction = process.env.NODE_ENV === 'production';
const port = process.env.PORT || 8000;

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
const templatesDir = path.join(__dirname, 'views');
const requiredTemplates = ['admin.ejs', 'admin-edit.ejs', 'overview.ejs', 'news.ejs', 'admin-login.ejs', 'register.ejs', 'login.ejs', 'about.ejs', 'contact.ejs', 'error.ejs'];

console.log('ðŸ“ Checking template files...');
requiredTemplates.forEach(template => {
  const filePath = path.join(templatesDir, template);
  if (fs.existsSync(filePath)) console.log(`âœ… ${template} - Ù…ÙˆØ¬ÙˆØ¯`);
  else console.log(`âŒ ${template} - ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
});

// Ø¥Ø¹Ø¯Ø§Ø¯ EJS
app.set('view engine', 'ejs');
app.set("views", path.join(__dirname, "views"));
app.set('views', templatesDir);

// Middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));

// ðŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Ø¨Ø¯ÙˆÙ† connect-mongo)
app.use(session({
  secret: process.env.SESSION_SECRET || 'familysecret',
  resave: false,
  saveUninitialized: false,
  cookie: { 
    secure: isProduction,
    maxAge: 1000 * 60 * 60 * 24 // 24 Ø³Ø§Ø¹Ø©
  }
}));

// Multer Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ±
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const uploadDir = 'public/uploads/';
    if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir, { recursive: true });
    cb(null, uploadDir);
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, 'image-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ 
  storage,
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) cb(null, true);
    else cb(new Error('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù ØµÙˆØ±Ø©!'), false);
  },
  limits: { fileSize: 5 * 1024 * 1024 }
});

// ----- MongoDB -----
const connectDB = async () => {
  try {
    if (!process.env.MONGO_URI) {
      throw new Error('âŒ MONGO_URI ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ· ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø©');
    }

    await mongoose.connect(process.env.MONGO_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('âœ… MongoDB Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');
  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨MongoDB:', err.message);
    process.exit(1);
  }
};

// ----- Admin Authentication -----
function isAdmin(req, res, next) {
  if (req.session && req.session.admin) return next();
  return res.redirect('/admin/login');
}

// ----- Routes -----
// Admin login
app.get('/admin/login', (req, res) => res.render('admin-login'));

app.post('/admin/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    if(username === 'admin' && password === 'admin123'){
      req.session.admin = true;
      return res.redirect('/admin');
    }
    res.render('admin-login', { error: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' });
  }
});

app.get('/admin/logout', (req, res) => {
  req.session.destroy(err => {
    if (err) console.error(err);
    res.redirect('/');
  });
});

// Admin panel - Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
app.get('/admin', isAdmin, async (req, res) => {
  try {
    const news = await News.find().sort({ createdAt: -1 });
    res.render('admin', { news });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' });
  }
});

// Add news
app.post('/admin/add-news', isAdmin, upload.single('image'), async (req, res) => {
  try {
    const newsData = { ...req.body, isPublished: req.body.isPublished === 'on' };
    if (req.file) newsData.imageUrl = '/uploads/' + req.file.filename;
    const newsItem = new News(newsData);
    await newsItem.save();
    res.redirect('/admin');
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø±' });
  }
});

// Edit news form
app.get('/admin/edit-news/:id', isAdmin, async (req, res) => {
  try {
    const newsItem = await News.findById(req.params.id);
    if (!newsItem) return res.status(404).render('error', { message: 'Ø§Ù„Ø®Ø¨Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    res.render('admin-edit', { newsItem });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' });
  }
});

// Update news
app.post('/admin/edit-news/:id', isAdmin, upload.single('image'), async (req, res) => {
  try {
    const updateData = { ...req.body, isPublished: req.body.isPublished === 'on' };

    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (req.file) {
      updateData.imageUrl = '/uploads/' + req.file.filename;
      const oldNews = await News.findById(req.params.id);
      if (oldNews.imageUrl && oldNews.imageUrl.startsWith('/uploads/')) {
        const oldImagePath = path.join(__dirname, 'public', oldNews.imageUrl);
        if (fs.existsSync(oldImagePath)) fs.unlinkSync(oldImagePath);
      }
    }

    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (req.body.removeImage === 'true') {
      const oldNews = await News.findById(req.params.id);
      if (oldNews.imageUrl && oldNews.imageUrl.startsWith('/uploads/')) {
        const oldImagePath = path.join(__dirname, 'public', oldNews.imageUrl);
        if (fs.existsSync(oldImagePath)) fs.unlinkSync(oldImagePath);
      }
      updateData.imageUrl = '';
    }

    await News.findByIdAndUpdate(req.params.id, updateData);
    res.redirect('/admin');
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¨Ø±' });
  }
});

// Delete news
app.post('/admin/delete-news/:id', isAdmin, async (req, res) => {
  try {
    const newsItem = await News.findById(req.params.id);
    if (newsItem.imageUrl && newsItem.imageUrl.startsWith('/uploads/')) {
      const imagePath = path.join(__dirname, 'public', newsItem.imageUrl);
      if (fs.existsSync(imagePath)) fs.unlinkSync(imagePath);
    }
    await News.findByIdAndDelete(req.params.id);
    res.redirect('/admin');
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±' });
  }
});

// ----- Customer routes -----
app.get('/register', (req, res) => {
  res.render('register', { user: req.session.user });
});

app.post('/register', async (req, res) => {
  try {
    const { name, email, password } = req.body;
    const existingUser = await User.findOne({ email });
    if (existingUser) return res.render('register', { error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', user: null });

    const hash = await bcrypt.hash(password, 10);
    const user = new User({ name, email, password: hash });
    await user.save();
    res.redirect('/login');
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
  }
});

app.get('/login', (req, res) => {
  res.render('login', { user: req.session.user });
});

app.post('/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    const user = await User.findOne({ email });
    if (!user) return res.render('login', { error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', user: null });

    const match = await bcrypt.compare(password, user.password);
    if (match) {
      req.session.user = user;
      return res.redirect('/');
    }
    res.render('login', { error: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', user: null });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' });
  }
});

app.get('/logout', (req, res) => {
  req.session.destroy(err => {
    if (err) console.error(err);
    res.redirect('/');
  });
});

// Overview page
app.get('/', async (req, res) => {
  try {
    const news = await News.find({ isPublished: true }).sort({ createdAt: -1 });
    res.render('overview', { news, user: req.session.user });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' });
  }
});

// News details
app.get('/news/:id', async (req, res) => {
  try {
    const newsItem = await News.findById(req.params.id);
    if (!newsItem) return res.status(404).render('error', { message: 'Ø§Ù„Ø®Ø¨Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });

    const comments = await Comment.find({ news: req.params.id }).populate('user');
    res.render('news', { news: newsItem, comments, user: req.session.user });
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±' });
  }
});

// Add comment
app.post('/news/:id/comment', async (req, res) => {
  try {
    if (!req.session.user) return res.render('news', { 
      news: await News.findById(req.params.id), 
      comments: await Comment.find({ news: req.params.id }).populate('user'),
      error: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚',
      user: null
    });

    if (!req.body.text || !req.body.text.trim()) return res.render('news', {
      news: await News.findById(req.params.id),
      comments: await Comment.find({ news: req.params.id }).populate('user'),
      error: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹',
      user: req.session.user
    });

    const comment = new Comment({
      news: req.params.id,
      user: req.session.user._id,
      text: req.body.text,
      rating: Number(req.body.rating) || 0
    });
    await comment.save();
    res.redirect(`/news/${req.params.id}`);
  } catch (err) {
    console.error(err);
    res.status(500).render('error', { message: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚' });
  }
});

// About page
app.get('/about', (req, res) => {
  res.render('about', { user: req.session.user });
});

// Contact page
app.get('/contact', (req, res) => {
  res.render('contact', { user: req.session.user });
});

app.post('/contact', (req, res) => {
  res.render('contact', { 
    user: req.session.user, 
    success: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹' 
  });
});

// 404 - ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
app.use((req, res) => {
  res.status(404).render('error', { 
    message: 'Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©',
    user: req.session.user 
  });
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).render('error', { 
    message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
    user: req.session.user 
  });
});

// ðŸ”§ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
const startServer = async () => {
  try {
    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await connectDB();
    
    // Ø§Ø³ØªÙ…Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„ØµØ­ÙŠØ­
    app.listen(port, '0.0.0.0', () => {
      console.log(`ðŸš€ Server running on port ${port}`);
      console.log(`ðŸŒ Available: http://localhost:${port}`);
      if (isProduction) {
        console.log('âœ… Running in production mode');
      } else {
        console.log('ðŸ”§ Running in development mode');
      }
    });
  } catch (error) {
    console.error('âŒ Failed to start server:', error);
    process.exit(1);
  }
};

// ðŸ”§ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
process.on('unhandledRejection', (error) => {
  console.error('Unhandled Rejection:', error);
  process.exit(1);
});

// Ø§Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
startServer();